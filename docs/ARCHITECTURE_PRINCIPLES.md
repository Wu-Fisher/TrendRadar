# TrendRadar 架构原则

本文档记录 TrendRadar 项目的核心架构原则和设计决策，作为后续开发的指导。

---

## 核心原则

### 1. LangBot 作为唯一消息出入口 (Single Message Gateway)

**状态**: 目标架构 (进行中)

**原则**: 所有与飞书（及其他 IM 平台）的消息交互必须通过 LangBot 进行，禁止绕过 LangBot 直接调用平台 API。

```
┌─────────────────────────────────────────────────────────────────────┐
│                         LangBot 统一网关                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   外部系统                    LangBot                    IM 平台     │
│   ─────────                  ─────────                  ─────────   │
│                                                                     │
│   ┌─────────────┐           ┌─────────────┐           ┌──────────┐ │
│   │ TrendRadar  │──queue──▶│             │           │          │ │
│   │   daemon    │           │             │           │          │ │
│   └─────────────┘           │   LangBot   │──────────▶│  飞书    │ │
│                             │   (唯一)    │           │          │ │
│   ┌─────────────┐           │             │◀──────────│          │ │
│   │  TaskTimer  │──plugin─▶│             │           │          │ │
│   │   日报等    │           │             │           │          │ │
│   └─────────────┘           └─────────────┘           └──────────┘ │
│                                                                     │
│   ❌ 禁止: daemon → 飞书 API (直接调用)                             │
│   ❌ 禁止: feishu_push → 飞书 API (绕过 LangBot)                    │
│   ✅ 允许: daemon → LangBot → 飞书 API                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**理由**:
1. **统一管理**: 所有消息经过单一出口，便于监控、审计、限流
2. **交互一致**: 用户看到的所有消息来自同一个机器人身份
3. **功能复用**: LangBot 的 AI 回复、命令处理可复用
4. **维护简化**: 减少需要维护的接口数量
5. **安全可控**: 敏感凭证集中管理，减少泄露风险

**过渡期安排**:
- 保留 `feishu_push` 服务用于对比测试
- 新增 LangBot 推送插件，并行运行
- 验证延迟可接受后，废弃直接 API 调用

**实施检查点**:
- [ ] LangBot PushQueue 插件完成
- [ ] 延迟测试通过 (目标: <15s 实时推送)
- [ ] daemon 移除直接 Webhook 调用
- [ ] feishu_push 服务废弃

---

### 2. 推送队列解耦 (Queue-based Decoupling)

**状态**: 已实现

**原则**: 消息生产者与发送者通过文件队列解耦，保证故障隔离和消息不丢失。

```
生产者 → .push_queue/*.json → 消费者 → 平台
```

**实现**:
- 队列目录: `config/.push_queue/`
- 消息格式: JSON 文件
- 原子写入: 临时文件 + rename
- 处理后归档: `.processed/` 目录

---

### 3. 配置类型安全 (Type-safe Configuration)

**状态**: 已实现 (ConfigManager)

**原则**: 使用 `ConfigManager` 类进行类型安全的配置访问，避免字符串键访问。

```python
# 推荐
cfg = ConfigManager(config)
timeout = cfg.ai.queue.max_wait_seconds

# 不推荐
timeout = config.get("AI", {}).get("QUEUE", {}).get("MAX_WAIT_SECONDS", 30)
```

---

## 架构决策记录 (ADR)

### ADR-001: 选择 LangBot 作为消息网关

**日期**: 2024-02-03

**背景**:
TrendRadar 需要向飞书群发送实时新闻推送。最初实现使用独立的 `feishu_push` 服务直接调用飞书 API。后引入 LangBot 作为交互式机器人。

**决策**:
统一使用 LangBot 作为所有消息的出入口，逐步废弃直接 API 调用。

**备选方案**:
1. ~~保持 feishu_push 独立~~ - 多入口，管理复杂
2. ~~daemon 直接调用 LangBot HTTP API~~ - LangBot 无公开 HTTP API
3. **LangBot 插件监听队列** - 复用现有队列机制，最小改动 ✅

**后果**:
- 正面: 统一出口，交互一致，便于维护
- 负面: 增加 LangBot 依赖，潜在延迟增加
- 风险: LangBot 故障影响所有推送

**缓解措施**:
- 保留 feishu_push 作为降级方案
- 监控 LangBot 健康状态
- 队列持久化保证消息不丢

---

### ADR-002: 推送延迟容忍度

**日期**: 2024-02-03

**决策**:
- 实时推送: 目标 <15s，可接受 <30s
- 日报推送: 无延迟要求

**理由**:
新闻时效性要求有限，15-30s 延迟不影响用户体验。

---

## 变更历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2024-02-03 | 1.0 | 初始版本，建立 LangBot 统一网关原则 | Claude Code |

