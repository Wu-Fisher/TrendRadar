# LangBot 独立部署配置
# 用于飞书交互机器人测试
# 启动: docker compose -f docker-compose-langbot.yml up -d

services:
  # LangBot 主服务
  langbot:
    image: rockchin/langbot:latest
    container_name: langbot
    volumes:
      - ./langbot_data:/app/data                    # LangBot 数据目录
      - ../config:/app/trendradar_config:rw         # TrendRadar 配置 (读写)
    ports:
      - "5300:5300"      # WebUI + Webhook 回调
      - "2280-2285:2280-2285"  # 平台反向连接 (WebSocket)
    restart: unless-stopped
    environment:
      - TZ=Asia/Shanghai
    networks:
      - langbot_network

  # LangBot 插件运行时 (独立进程)
  # 包含 PushQueue 插件 - 处理推送队列并发送到飞书
  langbot_plugin_runtime:
    image: rockchin/langbot:latest
    container_name: langbot_plugin_runtime
    volumes:
      - ./langbot_data/plugins:/app/data/plugins    # 插件目录 (含 PushQueue)
      - ../config:/app/trendradar_config:rw         # TrendRadar 配置 (推送队列)
      - ../output:/app/trendradar_output:ro         # TrendRadar 输出 (日报脚本需要)
    ports:
      - "5401:5401"      # 插件运行时端口
    restart: unless-stopped
    environment:
      - TZ=Asia/Shanghai
    command: ["uv", "run", "--no-sync", "-m", "langbot_plugin.cli.__init__", "rt"]
    networks:
      - langbot_network

  # ==================== 已废弃 ====================
  # 飞书推送服务 (已被 PushQueue 插件替代)
  # 如需临时启用，使用: docker compose -f docker-compose-langbot.yml --profile deprecated up -d feishu_push
  feishu_push:
    image: python:3.11-slim
    container_name: feishu_push
    profiles: ["deprecated"]  # 标记为废弃，默认不启动
    volumes:
      - ../scripts:/app/scripts:ro
      - ../config:/app/config:rw
      - ./langbot_data:/app/langbot_data:ro
    working_dir: /app
    command: ["bash", "-c", "pip install requests -q && python -u scripts/feishu_push_service.py --queue-dir /app/config/.push_queue --langbot-db /app/langbot_data/langbot.db --chat-ids $${FEISHU_CHAT_IDS:-oc_d29285f2dd1702ea24430464a43acc8c} --verbose"]
    restart: unless-stopped
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      - FEISHU_CHAT_IDS=${FEISHU_CHAT_IDS:-oc_d29285f2dd1702ea24430464a43acc8c}
      - FEISHU_OPEN_IDS=${FEISHU_OPEN_IDS:-}
    networks:
      - langbot_network

  # TrendRadar 爬虫守护进程 (引用自 docker-compose-build.yml)
  trendradar:
    extends:
      file: docker-compose-build.yml
      service: trendradar
    networks:
      - langbot_network

  # TrendRadar MCP 服务 (引用自 docker-compose-build.yml)
  trendradar-mcp:
    extends:
      file: docker-compose-build.yml
      service: trendradar-mcp
    networks:
      - langbot_network

networks:
  langbot_network:
    driver: bridge
