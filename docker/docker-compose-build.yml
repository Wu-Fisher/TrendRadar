services:
  trendradar:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: trendradar-ai:test
    container_name: trendradar
    restart: unless-stopped

    ports:
      - "127.0.0.1:${WEBSERVER_PORT:-8080}:${WEBSERVER_PORT:-8080}"

    volumes:
      - ../config:/app/config
      - ../output:/app/output
      - ../scripts:/app/scripts

    environment:
      - TZ=Asia/Shanghai
      # Web 服务器
      - ENABLE_WEBSERVER=${ENABLE_WEBSERVER:-false}
      - WEBSERVER_PORT=${WEBSERVER_PORT:-8080}
      # 通知渠道
      - FEISHU_WEBHOOK_URL=${FEISHU_WEBHOOK_URL:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - DINGTALK_WEBHOOK_URL=${DINGTALK_WEBHOOK_URL:-}
      - WEWORK_WEBHOOK_URL=${WEWORK_WEBHOOK_URL:-}
      - WEWORK_MSG_TYPE=${WEWORK_MSG_TYPE:-}
      # 邮件配置
      - EMAIL_FROM=${EMAIL_FROM:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - EMAIL_TO=${EMAIL_TO:-}
      - EMAIL_SMTP_SERVER=${EMAIL_SMTP_SERVER:-}
      - EMAIL_SMTP_PORT=${EMAIL_SMTP_PORT:-}
      # ntfy配置
      - NTFY_SERVER_URL=${NTFY_SERVER_URL:-https://ntfy.sh}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      - NTFY_TOKEN=${NTFY_TOKEN:-}
      # Bark配置
      - BARK_URL=${BARK_URL:-}
      # Slack配置
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      # 通用Webhook配置
      - GENERIC_WEBHOOK_URL=${GENERIC_WEBHOOK_URL:-}
      - GENERIC_WEBHOOK_TEMPLATE=${GENERIC_WEBHOOK_TEMPLATE:-}
      # AI 配置（ai_analysis 和 ai_translation 共享模型配置）
      - AI_ANALYSIS_ENABLED=${AI_ANALYSIS_ENABLED:-false}
      - AI_API_KEY=${AI_API_KEY:-}
      - AI_MODEL=${AI_MODEL:-}
      - AI_API_BASE=${AI_API_BASE:-}
      # 远程存储配置（S3 兼容协议）
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL:-}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      - S3_REGION=${S3_REGION:-}
      # 运行模式
      - CRON_SCHEDULE=${CRON_SCHEDULE:-*/30 * * * *}
      - RUN_MODE=${RUN_MODE:-cron}
      - IMMEDIATE_RUN=${IMMEDIATE_RUN:-true}
      # 守护进程配置
      - CRAWLER_POLL_INTERVAL=${CRAWLER_POLL_INTERVAL:-10}
      - CRAWLER_NO_PUSH=${CRAWLER_NO_PUSH:-false}
      - CRAWLER_VERBOSE=${CRAWLER_VERBOSE:-false}
      - CRAWLER_ENABLE_AI=${CRAWLER_ENABLE_AI:-false}
      - CRAWLER_USE_CREWAI=${CRAWLER_USE_CREWAI:-false}

  trendradar-mcp:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mcp
    container_name: trendradar-mcp
    restart: unless-stopped

    ports:
      - "127.0.0.1:3333:3333"

    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output

    environment:
      - TZ=Asia/Shanghai

  # 飞书推送服务 (监听推送队列 -> 发送到飞书)
  feishu_push:
    image: python:3.11-slim
    container_name: feishu_push
    restart: unless-stopped
    profiles: ["feishu"]  # 可选启动: docker compose --profile feishu up -d

    volumes:
      - ../scripts:/app/scripts:ro
      - ../config:/app/config:rw
      - ./langbot_data:/app/langbot_data:ro  # LangBot 数据 (读取凭证)

    working_dir: /app
    command: >
      bash -c "pip install requests -q &&
      python -u scripts/feishu_push_service.py
      --queue-dir /app/config/.push_queue
      --langbot-db /app/langbot_data/langbot.db
      --verbose"

    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      - FEISHU_CHAT_IDS=${FEISHU_CHAT_IDS:-}
      - FEISHU_OPEN_IDS=${FEISHU_OPEN_IDS:-}
      - FEISHU_APP_ID=${FEISHU_APP_ID:-}
      - FEISHU_APP_SECRET=${FEISHU_APP_SECRET:-}
